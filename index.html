<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time-Locked Camera</title>

<style>
body { font-family: system-ui,-apple-system,Segoe UI,Roboto; margin:16px; }
video, img { width:100%; max-width:520px; border-radius:12px; background:#eee; }
button, select { padding:10px 14px; border-radius:10px; border:1px solid #ccc; margin:6px 6px 6px 0; font-size:16px; }
.row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.card { border:1px solid #e5e5e5; border-radius:12px; padding:12px; max-width:540px; }
.muted { color:#666; }
.pill { padding:4px 10px; border-radius:999px; border:1px solid #ddd; }
.danger { background:#fff5f5; border-color:#f2b8b5; }
.ok { background:#f5fff8; border-color:#b8e6c8; }
.mono { font-family:ui-monospace,SFMono-Regular,Menlo,monospace; }
.masked { filter: blur(2px); }
</style>
</head>

<body>
<h2>Time-Locked Camera v0.5</h2>
<p class="muted">
This app takes a picture and lock it for a preset time period
</p>

<div class="card">
  <div class="row">
    <button data-preset="1">1 min</button>
    <button data-preset="10">10 min</button>
    <button data-preset="30">30 min</button>
    <button data-preset="60">1 hour</button>
  </div>

  <div class="row">
    <select id="hours"></select> h
    <select id="mins"></select> m
  </div>

  <div class="row">
    <button id="start">Start Camera</button>
    <button id="switch" disabled>Switch Camera</button>
    <button id="snap" disabled>Take Photo</button>
    <button id="clear">Clear</button>
  </div>

  <div class="row">
    <span id="state" class="pill muted">No photo</span>
    <span id="countdown" class="pill mono">--:--:--</span>
  </div>

  <p id="status" class="muted"></p>

  <video id="video" autoplay playsinline muted style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>
  <img id="photo" style="display:none" />
</div>

<script>
/* ---------- IndexedDB ---------- */
const DB = "timelock_v1", STORE = "kv";
const openDB = () => new Promise(r => {
  const req = indexedDB.open(DB,1);
  req.onupgradeneeded = () => req.result.createObjectStore(STORE);
  req.onsuccess = () => r(req.result);
});
const get = async k => (await openDB()).transaction(STORE).objectStore(STORE).get(k);
const set = async (k,v) => { const db=await openDB(); const t=db.transaction(STORE,"readwrite"); t.objectStore(STORE).put(v,k); };
const del = async k => { const db=await openDB(); const t=db.transaction(STORE,"readwrite"); t.objectStore(STORE).delete(k); };

/* ---------- UI ---------- */
const $ = id => document.getElementById(id);
const video=$("video"), canvas=$("canvas"), img=$("photo");
const stateEl=$("state"), cdEl=$("countdown"), statusEl=$("status");

/* ---------- Time ---------- */
const fmt = ms => {
  ms=Math.max(0,ms);
  const s=Math.floor(ms/1000);
  return [Math.floor(s/3600),Math.floor(s/60)%60,s%60].map(v=>String(v).padStart(2,"0")).join(":");
};

/* ---------- Mosaic ---------- */
async function mosaic(data){
  const im=new Image(); im.src=data; await im.decode();
  const b=26, w=im.width, h=im.height;
  const s=document.createElement("canvas");
  s.width=Math.max(1,w/b); s.height=Math.max(1,h/b);
  s.getContext("2d").drawImage(im,0,0,s.width,s.height);
  const o=document.createElement("canvas");
  o.width=w; o.height=h;
  const c=o.getContext("2d");
  c.imageSmoothingEnabled=false;
  c.drawImage(s,0,0,w,h);
  return o.toDataURL("image/jpeg",0.8);
}

/* ---------- Camera ---------- */
let stream=null, facing="environment";
async function startCam(){
  stopCam();
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}});
  video.srcObject=stream; video.style.display="block";
  $("snap").disabled=false; $("switch").disabled=false;
}
function stopCam(){ if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;} }

/* ---------- Logic ---------- */
async function render(){
  const unlockAt=await get("unlockAt");
  const full=await get("photo");
  const mask=await get("mask");

  if(!unlockAt||!full){
    img.style.display="none"; cdEl.textContent="--:--:--";
    stateEl.textContent="No photo"; return;
  }

  const left=unlockAt-Date.now();
  if(left>0){
    stateEl.textContent="Locked"; stateEl.className="pill danger";
    cdEl.textContent=fmt(left);
    img.src=mask; img.style.display="block"; img.className="masked";
  }else{
    stateEl.textContent="Unlocked"; stateEl.className="pill ok";
    cdEl.textContent="00:00:00";
    img.src=full; img.style.display="block"; img.className="";
  }
}

$("start").onclick=startCam;
$("switch").onclick=()=>{ facing=facing==="environment"?"user":"environment"; startCam(); };

$("snap").onclick=async()=>{
  const delay=(+$("hours").value*60 + +$("mins").value)*60000;
  if(delay<=0){ statusEl.textContent="Set delay first"; return; }

  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const full=canvas.toDataURL("image/jpeg",0.92);
  const mask=await mosaic(full);

  await set("photo",full);
  await set("mask",mask);
  await set("unlockAt",Date.now()+delay);

  stopCam(); render();
};

$("clear").onclick=async()=>{
  await del("photo"); await del("mask"); await del("unlockAt");
  stopCam(); render();
};

/* ---------- Init ---------- */
for(let i=0;i<24;i++) $("hours").add(new Option(i,i));
for(let i=0;i<60;i++) $("mins").add(new Option(i,String(i).padStart(2,"0")));
document.querySelectorAll("[data-preset]").forEach(b=>b.onclick=()=>{
  const m=+b.dataset.preset; $("hours").value=Math.floor(m/60); $("mins").value=m%60;
});
setInterval(render,1000); render();
</script>
</body>
</html>
