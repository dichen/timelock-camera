<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Time-Locked Camera</title>

<style>
  body { font-family: system-ui,-apple-system,Segoe UI,Roboto; margin: 14px; }
  .muted { color:#666; }
  .card { border:1px solid #e5e5e5; border-radius:14px; padding:12px; max-width:560px; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  button, select { padding:10px 14px; border-radius:12px; border:1px solid #ccc; font-size:16px; background:#fff; }
  .pill { padding:6px 12px; border-radius:999px; border:1px solid #ddd; display:inline-block; }
  .danger { background:#fff5f5; border-color:#f2b8b5; }
  .ok { background:#f5fff8; border-color:#b8e6c8; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }

  /* Countdown emphasis */
  .header {
    margin-bottom: 10px;
  }
  .countdownBig {
    font-size: 40px;
    line-height: 1.1;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .topBar {
    display:flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 6px;
  }

  /* Media first (photo / live view) */
  .mediaWrap {
    margin-top: 10px;
    margin-bottom: 10px;
  }
  video, img {
    width: 100%;
    max-width: 520px;
    border-radius: 14px;
    background: #eee;
    display:block;
  }
  .masked { filter: blur(2px); }

  /* Keep controls compact */
  .controls { margin-top: 8px; }
  .btnWide { flex: 1 1 auto; }
  .status { margin-top: 8px; }
</style>
</head>

<body>
  <div class="card">

    <!-- TOP: Countdown + State (always visible, no scrolling needed) -->
    <div class="header">
      <div class="countdownBig mono" id="countdown">--:--:--</div>
      <div class="topBar">
        <span id="state" class="pill">No photo</span>
        <span class="pill muted mono" id="unlockAtLabel">Unlock at: —</span>
      </div>
      <p class="muted" style="margin:8px 0 0 0;">
        v0.7 <br>
        Warning: For casual use only. If used for self bondage play, always ensure you have backup method to unlock or emergency contact to call
      </p>
    </div>

    <!-- MEDIA: Photo preview / Live camera view ABOVE buttons -->
    <div class="mediaWrap">
      <video id="video" autoplay playsinline muted style="display:none;"></video>
      <img id="photo" alt="Preview" style="display:none;" />
      <canvas id="canvas" style="display:none;"></canvas>
    </div>

    <!-- PRESETS -->
    <div class="row">
      <button class="btnWide" data-preset="1">1 min</button>
      <button class="btnWide" data-preset="10">10 min</button>
      <button class="btnWide" data-preset="30">30 min</button>
      <button class="btnWide" data-preset="60">1 hour</button>
    </div>

    <!-- DELAY -->
    <div class="row controls">
      <select id="hours" aria-label="Hours"></select>
      <span class="muted">h</span>
      <select id="mins" aria-label="Minutes"></select>
      <span class="muted">m</span>
    </div>

    <!-- ACTION BUTTONS -->
    <div class="row controls">
      <button id="start" class="btnWide">Start Camera</button>
      <button id="switch" class="btnWide" disabled>Switch Camera</button>
      <button id="snap" class="btnWide" disabled>Take Photo</button>
      <button id="clear" class="btnWide">Clear</button>
    </div>

    <p id="status" class="muted status"></p>
  </div>

<script>
/* ---------- IndexedDB ---------- */
const DB = "timelock_v3", STORE = "kv";

const openDB = () => new Promise((resolve, reject) => {
  const req = indexedDB.open(DB, 1);
  req.onupgradeneeded = () => req.result.createObjectStore(STORE);
  req.onsuccess = () => resolve(req.result);
  req.onerror = () => reject(req.error);
});

async function idbGet(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readonly");
    const req = tx.objectStore(STORE).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbSet(key, val) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).put(val, key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}
async function idbDel(key) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE, "readwrite");
    tx.objectStore(STORE).delete(key);
    tx.oncomplete = () => resolve();
    tx.onerror = () => reject(tx.error);
  });
}

/* ---------- UI ---------- */
const $ = id => document.getElementById(id);
const video = $("video");
const canvas = $("canvas");
const img = $("photo");
const stateEl = $("state");
const cdEl = $("countdown");
const statusEl = $("status");
const unlockAtLabel = $("unlockAtLabel");

/* ---------- Time formatting ---------- */
function fmt(ms) {
  ms = Math.max(0, ms);
  const s = Math.floor(ms / 1000);
  const hh = String(Math.floor(s / 3600)).padStart(2, "0");
  const mm = String(Math.floor((s / 60) % 60)).padStart(2, "0");
  const ss = String(s % 60).padStart(2, "0");
  return `${hh}:${mm}:${ss}`;
}

/* Prevent broken image icon on iOS */
function hideImg() {
  img.style.display = "none";
  img.className = "";
  img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";
}
function showImg(src, masked) {
  img.src = src;
  img.style.display = "block";
  img.className = masked ? "masked" : "";
}

/* ---------- Mosaic (memory-safe) ---------- */
const MOSAIC_BLOCK_PX = 26;
const MASK_MAX_DIM = 1024;

function loadImage(dataUrl) {
  return new Promise((resolve, reject) => {
    const im = new Image();
    im.onload = () => resolve(im);
    im.onerror = reject;
    im.src = dataUrl;
  });
}

async function mosaicPreview(fullDataUrl) {
  const im = await loadImage(fullDataUrl);
  const srcW = im.naturalWidth || im.width;
  const srcH = im.naturalHeight || im.height;

  const scale = Math.min(1, MASK_MAX_DIM / Math.max(srcW, srcH));
  const outW = Math.max(1, Math.round(srcW * scale));
  const outH = Math.max(1, Math.round(srcH * scale));

  const work = document.createElement("canvas");
  work.width = outW;
  work.height = outH;
  work.getContext("2d").drawImage(im, 0, 0, outW, outH);

  const tinyW = Math.max(1, Math.floor(outW / MOSAIC_BLOCK_PX));
  const tinyH = Math.max(1, Math.floor(outH / MOSAIC_BLOCK_PX));

  const tiny = document.createElement("canvas");
  tiny.width = tinyW;
  tiny.height = tinyH;

  const tctx = tiny.getContext("2d");
  tctx.imageSmoothingEnabled = true;
  tctx.drawImage(work, 0, 0, outW, outH, 0, 0, tinyW, tinyH);

  const out = document.createElement("canvas");
  out.width = outW;
  out.height = outH;

  const octx = out.getContext("2d");
  octx.imageSmoothingEnabled = false;
  octx.drawImage(tiny, 0, 0, tinyW, tinyH, 0, 0, outW, outH);

  return out.toDataURL("image/jpeg", 0.82);
}

/* ---------- Camera ---------- */
let stream = null;
let facing = "environment";

function stopCam() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.style.display = "none";
  $("snap").disabled = true;
  $("switch").disabled = true;
}

async function startCam() {
  stopCam();
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing }, audio: false });
  video.srcObject = stream;
  video.style.display = "block";
  $("snap").disabled = false;
  $("switch").disabled = false;
  statusEl.textContent = "Camera started. Tap 'Take Photo'.";
}

/* ---------- Render ---------- */
async function render() {
  const unlockAt = await idbGet("unlockAt");
  const full = await idbGet("photo");
  const mask = await idbGet("mask");

  if (!unlockAt || !full) {
    stateEl.textContent = "No photo";
    stateEl.className = "pill";
    cdEl.textContent = "--:--:--";
    unlockAtLabel.textContent = "Unlock at: —";
    statusEl.textContent = "Ready. Start camera and take a photo.";
    hideImg();
    return;
  }

  const left = unlockAt - Date.now();
  unlockAtLabel.textContent = "Unlock at: " + new Date(unlockAt).toLocaleString();

  if (left > 0) {
    stateEl.textContent = "Locked";
    stateEl.className = "pill danger";
    cdEl.textContent = fmt(left);
    statusEl.textContent = "Masked preview shown during lock.";

    // During lock: show masked preview; hide live view if still open
    if (video.style.display !== "none") {
      // Keep live view visible while user is actively shooting; once shot, we stop cam anyway.
    }
    if (mask) {
      video.style.display = "none";
      showImg(mask, true);
    } else {
      hideImg();
    }
  } else {
    stateEl.textContent = "Unlocked";
    stateEl.className = "pill ok";
    cdEl.textContent = "00:00:00";
    statusEl.textContent = "Unlocked.";
    video.style.display = "none";
    showImg(full, false);
  }
}

/* ---------- Actions ---------- */
$("start").onclick = async () => {
  try { await startCam(); }
  catch (_) {
    statusEl.textContent = "Camera permission denied/unavailable. Ensure HTTPS and allow Camera access.";
    stopCam();
  }
};

$("switch").onclick = async () => {
  facing = (facing === "environment") ? "user" : "environment";
  try { await startCam(); } catch (_) {}
};

$("snap").onclick = async () => {
  const hours = String($("hours").value);
  const mins = String($("mins").value);
  const delayMin = (Number(hours) * 60) + Number(mins);
  const delayMs = delayMin * 60000;

  if (!delayMs || delayMs <= 0) {
    statusEl.textContent = "Set a delay first (e.g., 1 min).";
    return;
  }
  if (!stream) return;

  canvas.width = video.videoWidth || 1280;
  canvas.height = video.videoHeight || 720;
  canvas.getContext("2d").drawImage(video, 0, 0);

  const full = canvas.toDataURL("image/jpeg", 0.92);

  let mask = null;
  try { mask = await mosaicPreview(full); } catch (_) { mask = null; }

  await idbSet("photo", full);
  await idbSet("mask", mask);
  await idbSet("unlockAt", Date.now() + delayMs);

  stopCam();
  await render();
};

$("clear").onclick = async () => {
  await idbDel("photo");
  await idbDel("mask");
  await idbDel("unlockAt");
  stopCam();
  await render();
};

/* ---------- Init ---------- */
(function init() {
  for (let i = 0; i < 24; i++) $("hours").add(new Option(String(i), String(i)));
  for (let i = 0; i < 60; i++) {
    const v = String(i).padStart(2, "0");
    $("mins").add(new Option(v, v));
  }

  // default 1 hour
  $("hours").value = "1";
  $("mins").value = "00";

  document.querySelectorAll("[data-preset]").forEach(btn => {
    btn.onclick = () => {
      const total = Number(btn.dataset.preset);
      const h = Math.floor(total / 60);
      const m = total % 60;
      $("hours").value = String(h);
      $("mins").value = String(m).padStart(2, "0");
      statusEl.textContent = `Delay set to ${total} minute(s).`;
    };
  });

  hideImg();
  setInterval(render, 1000);
  render();
})();
</script>
</body>
</html>
